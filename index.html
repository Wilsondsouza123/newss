<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>US Pre-Market Dashboard — Gainers • Losers • News • 1-Week Trend</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{--bg:#f6f7f9;--card:#fff;--border:#e3e6ea;--text:#1c2128;--muted:#6b7280;--accent:#0b5cab;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:rgba(246,247,249,.96);backdrop-filter:saturate(180%) blur(6px);
          border-bottom:1px solid var(--border);padding:12px 16px;z-index:20;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:16px}
  input[type="password"],input[type="text"],input[type="number"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;min-width:260px}
  .btn{background:#111;color:#fff;border:1px solid #111;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#fff;color:#111;border-color:var(--border)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
  .grid{display:grid;grid-template-columns:360px 1fr 420px;gap:16px;padding:16px}
  @media (max-width:1200px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .card h2{margin:0;padding:10px 12px;background:#111;color:#fff;font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .pad{padding:10px 12px}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-top:1px solid var(--border);text-align:left}
  thead th{background:#f1f2f4;border-top:none}
  tr:hover{background:#fafafa}
  .right{text-align:right}
  .sym{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:600}
  .gain{color:#0a7a36}
  .loss{color:#b42318}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .news-item{border-top:1px solid var(--border);padding:10px 0}
  .news-item:first-child{border-top:none}
  .news-item a{color:var(--accent);text-decoration:none}
  .news-item a:hover{text-decoration:underline}
  canvas{width:100%;height:260px}
  .hint{padding:8px 12px;background:#fff1;display:inline-block;border:1px dashed var(--border);border-radius:10px}
</style>
</head>
<body>

<header>
  <h1>US Pre-Market Dashboard</h1>
  <input id="apiKey" type="password" placeholder="Polygon API Key (required)" />
  <button class="btn" id="btnGainers">Load Gainers</button>
  <button class="btn" id="btnLosers">Load Losers</button>
  <button class="btn secondary" id="btnAuto">Auto-Refresh: OFF (2 min)</button>
  <span class="pill" id="stamp">—</span>
</header>

<div class="grid">
  <!-- Movers list -->
  <div class="card" id="moversCard">
    <h2>
      Pre-Market Movers
      <span class="muted" id="moversHint">Click a row to see news & 1-week trend</span>
    </h2>
    <div class="pad">
      <table id="movers">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Name</th>
            <th class="right">Premkt %</th>
            <th class="right">Premkt Chg</th>
            <th class="right">Premkt Px</th>
            <th class="right">Vol</th>
          </tr>
        </thead>
        <tbody id="moversBody"><tr><td colspan="6" class="muted">Load gainers or losers…</td></tr></tbody>
      </table>
      <div class="muted" style="margin-top:8px">
        Data: Polygon “Top Market Movers” (updates starting ~4:00 AM ET; min vol 10k). Extended hours can be delayed depending on plan.
      </div>
    </div>
  </div>

  <!-- Chart / details -->
  <div class="card">
    <h2 id="chartTitle">1-Week Price Trend</h2>
    <div class="pad">
      <canvas id="chart"></canvas>
      <div class="muted" id="chartNote" style="margin-top:8px">Shows last ~7 calendar days (daily bars). Select a symbol on the left.</div>
      <div id="detailStats" class="pad" style="padding-left:0"></div>
    </div>
  </div>

  <!-- News -->
  <div class="card">
    <h2>Latest News</h2>
    <div class="pad" id="newsBox">
      <div class="muted">Select a symbol to load headlines and summaries.</div>
    </div>
  </div>
</div>

<!-- Chart.js (lightweight via CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ===== Config & helpers ===== */
const el = id => document.getElementById(id);
const fmtPct = v => (v>0?'+':'') + v.toFixed(2) + '%';
const fmtNum = n => n?.toLocaleString('en-US');
const todayISO = () => new Date().toISOString().slice(0,10);
const daysAgoISO = d => { const x=new Date(); x.setDate(x.getDate()-d); return x.toISOString().slice(0,10); };

let autoTimer=null, autoOn=false, chart, currentList='gainers', API='', STAMP = el('stamp');

/* ===== Core fetchers (Polygon.io) =====
   - Movers (gainers/losers): /v2/snapshot/locale/us/markets/stocks/{direction}
   - News: /v2/reference/news?ticker=TSLA&limit=10
   - Aggregates (daily OHLC): /v2/aggs/ticker/AAPL/range/1/day/{from}/{to}
*/
async function poly(path, params={}){
  const key = API || el('apiKey').value.trim();
  if(!key) throw new Error('API key missing');
  const usp = new URLSearchParams({...params, apiKey:key});
  const url = `https://api.polygon.io${path}?${usp.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function loadMovers(direction='gainers'){
  currentList = direction;
  API = el('apiKey').value.trim();
  const body = el('moversBody');
  body.innerHTML = `<tr><td colspan="6" class="muted">Loading ${direction}…</td></tr>`;
  try{
    const data = await poly(`/v2/snapshot/locale/us/markets/stocks/${direction}`);
    const rows = (data.tickers||[]).map(t=>{
      // Fields vary by plan; fall back gracefully
      const sym = t.ticker || t.T || '';
      const name = t.name || '';
      const chg = t.todaysChange ?? (t.day?.c && t.prevDay?.c ? (t.day.c - t.prevDay.c) : null);
      const chgPct = t.todaysChangePerc ?? (t.prevDay?.c ? ((t.day?.c - t.prevDay.c)/t.prevDay.c*100) : null);
      const px = t.lastTrade?.p ?? t.min?.c ?? t.day?.c ?? null;
      const vol = t.day?.v ?? t.min?.v ?? null;
      return {sym,name,chg,chgPct,px,vol};
    });

    if(!rows.length){
      body.innerHTML = `<tr><td colspan="6" class="muted">No data returned (plan/delays or market closed). Try again closer to 12:00 GST (4:00 AM ET).</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(r=>`
      <tr data-sym="${r.sym}">
        <td class="sym">${r.sym}</td>
        <td>${r.name??''}</td>
        <td class="right ${r.chgPct>=0?'gain':'loss'}">${r.chgPct!=null?fmtPct(r.chgPct):'—'}</td>
        <td class="right ${r.chg>=0?'gain':'loss'}">${r.chg!=null?r.chg.toFixed(2):'—'}</td>
        <td class="right">${r.px!=null?r.px.toFixed(2):'—'}</td>
        <td class="right">${r.vol!=null?fmtNum(r.vol):'—'}</td>
      </tr>
    `).join('');

    // bind clicks
    [...body.querySelectorAll('tr[data-sym]')].forEach(tr=>{
      tr.addEventListener('click', ()=>selectSymbol(tr.dataset.sym));
    });

    STAMP.textContent = `Last refresh: ${new Date().toLocaleTimeString()}`;
  }catch(err){
    body.innerHTML = `<tr><td colspan="6" class="muted">Error: ${err.message}. Check API key & CORS/network.</td></tr>`;
  }
}

async function selectSymbol(ticker){
  el('chartTitle').textContent = `1-Week Trend — ${ticker}`;
  el('newsBox').innerHTML = `<div class="muted">Loading news for ${ticker}…</div>`;
  el('detailStats').innerHTML = '';

  // 1) News (latest 8)
  try{
    const news = await poly('/v2/reference/news', { ticker, limit: 8 });
    if(!news?.results?.length){
      el('newsBox').innerHTML = `<div class="muted">No recent headlines.</div>`;
    }else{
      el('newsBox').innerHTML = news.results.map(n=>`
        <div class="news-item">
          <a href="${n.article_url||n.url}" target="_blank" rel="noopener">${escapeHtml(n.title||'Headline')}</a>
          <div class="muted">${escapeHtml(n.description||'')}</div>
          <div class="muted">${new Date(n.published_utc||n.published_at).toLocaleString()} • ${escapeHtml(n.source||'')}</div>
        </div>
      `).join('');
    }
  }catch(e){
    el('newsBox').innerHTML = `<div class="muted">News error: ${e.message}</div>`;
  }

  // 2) 1-week daily aggregates for sparkline
  try{
    const to = todayISO();
    const from = daysAgoISO(8); // buffer for weekends/holidays
    const agg = await poly(`/v2/aggs/ticker/${encodeURIComponent(ticker)}/range/1/day/${from}/${to}`, { adjusted:true, sort:'asc', limit:120 });
    const pts = (agg.results||[]).map(r=>({ t:new Date(r.t), c:r.c }));
    if(!pts.length){
      draw([],ticker);
      el('chartNote').textContent = 'No recent daily bars returned.';
      return;
    }
    draw(pts,ticker);

    // Basic stat block (last close, 5-day change)
    if(pts.length>=2){
      const last = pts[pts.length-1].c;
      const first = pts[0].c;
      const chg = last-first;
      const pct = (chg/first)*100;
      el('detailStats').innerHTML = `
        <div class="muted">Last close: <strong>${last.toFixed(2)}</strong> • 1-week: <strong class="${pct>=0?'gain':'loss'}">${fmtPct(pct)}</strong></div>
      `;
    }
  }catch(e){
    el('chartNote').textContent = `Aggregates error: ${e.message}`;
  }
}

function draw(points, sym){
  const ctx = el('chart').getContext('2d');
  const labels = points.map(p=>p.t.toLocaleDateString());
  const data = points.map(p=>p.c);
  if(chart){ chart.destroy(); }
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label: sym, data, tension:.2, pointRadius:0, borderWidth:2 }]},
    options:{
      responsive:true,
      scales:{ x:{ grid:{display:false}}, y:{ ticks:{ callback:v=>'$'+v }}},
      plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=>`$${c.formattedValue}` }}}
    }
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ===== UI wiring ===== */
el('btnGainers').addEventListener('click',()=>loadMovers('gainers'));
el('btnLosers').addEventListener('click',()=>loadMovers('losers'));

el('btnAuto').addEventListener('click',()=>{
  autoOn = !autoOn;
  el('btnAuto').textContent = `Auto-Refresh: ${autoOn?'ON':'OFF'} (2 min)`;
  if(autoTimer) clearInterval(autoTimer);
  if(autoOn){
    autoTimer = setInterval(()=>loadMovers(currentList), 120000);
    loadMovers(currentList);
  }
});
</script>

<!--
Notes:
• Polygon Top Market Movers starts repopulating around 4:00 AM ET (~12:00 GST) and includes only tickers with volume ≥10k.
• News & aggregates endpoints are also from Polygon.
-->
</body>
</html>
